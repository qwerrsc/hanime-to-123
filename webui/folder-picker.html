<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>æ–‡ä»¶å¤¹é€‰æ‹©å™¨ - Hanime 123äº‘ç›˜ä¸‹è½½åŠ©æ‰‹</title>
    <link rel="stylesheet" href="/static/css/style.css?v=2.0.1">
    <style>
        body {
            background-color: #1e1e1e;
            color: #e5e5e5;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #3d3d3d;
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
            color: #ff6b6b;
        }

        .close-btn {
            background: #3d3d3d;
            border: none;
            color: #e5e5e5;
            cursor: pointer;
            font-size: 20px;
            width: 36px;
            height: 36px;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .close-btn:hover {
            background: #4d4d4d;
        }

        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .toolbar button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .btn-primary {
            background: #ff6b6b;
            color: white;
        }

        .btn-primary:hover {
            background: #ff5252;
        }

        .btn-secondary {
            background: #3d3d3d;
            color: #e5e5e5;
        }

        .btn-secondary:hover {
            background: #4d4d4d;
        }

        .current-path {
            flex: 1;
            margin-left: 10px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #999;
            font-size: 14px;
        }

        .folder-list {
            background: #252525;
            border-radius: 8px;
            padding: 15px;
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
        }

        .folder-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #2d2d2d;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .folder-item:hover {
            background: #3d3d3d;
        }

        .folder-item.selected {
            background: #3d3d3d;
            border: 2px solid #ff6b6b;
        }

        .folder-item-icon {
            font-size: 24px;
            margin-right: 12px;
        }

        .folder-item-info {
            flex: 1;
        }

        .folder-item-name {
            font-weight: 500;
            color: #e5e5e5;
            margin-bottom: 4px;
        }

        .folder-item-id {
            font-size: 12px;
            color: #777;
        }

        .copy-input {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #3d3d3d;
        }

        .copy-input input {
            flex: 1;
            padding: 10px;
            background: #252525;
            border: 1px solid #3d3d3d;
            border-radius: 6px;
            color: #e5e5e5;
            font-size: 14px;
        }

        .copy-input input:focus {
            outline: none;
            border-color: #ff6b6b;
        }

        .search-input {
            flex: 1;
            padding: 8px 12px;
            background: #252525;
            border: 1px solid #3d3d3d;
            border-radius: 6px;
            color: #e5e5e5;
            font-size: 13px;
            min-width: 200px;
        }

        .search-input:focus {
            outline: none;
            border-color: #ff6b6b;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #999;
        }

        .empty {
            text-align: center;
            padding: 60px;
            color: #666;
        }

        .message {
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .message-info {
            background: rgba(79, 195, 247, 0.1);
            border: 1px solid rgba(79, 195, 247, 0.3);
            color: #4fc3f7;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>æ–‡ä»¶å¤¹é€‰æ‹©å™¨</h1>
            <button class="close-btn" onclick="window.close()">Ã—</button>
        </div>

        <div class="message message-info">
            è¯·é€‰æ‹©æ–‡ä»¶å¤¹ï¼Œç„¶åç‚¹å‡»"å¤åˆ¶ID"æŒ‰é’®å°†æ–‡ä»¶å¤¹IDå¤åˆ¶åˆ°å‰ªè´´æ¿
        </div>

        <div class="toolbar">
            <button class="btn-secondary" onclick="goBackFolder()">è¿”å›ä¸Šä¸€çº§</button>
            <span class="current-path" id="current-path">/</span>
        </div>

        <div class="toolbar">
            <div style="display: flex; gap: 10px; flex: 1;">
                <input type="text" id="folder-search" placeholder="æœç´¢æ–‡ä»¶å¤¹..." class="search-input">
                <button class="btn-primary" onclick="searchFolders()">æœç´¢</button>
                <button class="btn-secondary" onclick="clearSearch()">æ¸…é™¤</button>
            </div>
            <div id="search-status" style="color: #999; font-size: 12px;"></div>
        </div>

        <div class="folder-list" id="folder-list">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>

        <div class="copy-input">
            <input type="text" id="selected-folder-id" placeholder="è¯·é€‰æ‹©æ–‡ä»¶å¤¹" readonly>
            <button class="btn-primary" onclick="copyFolderId()">å¤åˆ¶ID</button>
        </div>
    </div>

    <script>
        // APIåŸºç¡€URL
        const API_BASE = '/api';

        // å½“å‰çˆ¶ç›®å½•ID
        let currentParentId = 0;

        // é€‰ä¸­çš„æ–‡ä»¶å¤¹ID
        let selectedFolderId = null;

        // è·¯å¾„æ ˆ
        let folderPathStack = [{ id: 0, name: 'æ ¹ç›®å½•' }];

        // ç”¨æˆ·é…ç½®çš„æ ¹ç›®å½•ID
        let userRootDirId = 0;

        // å­˜å‚¨æ‰€æœ‰æ–‡ä»¶å¤¹æ•°æ®ç”¨äºæœç´¢
        let allFoldersCache = null;
        let isSearchMode = false;
        // å­˜å‚¨å½“å‰çˆ¶ç›®å½•çš„å­æ–‡ä»¶å¤¹åˆ—è¡¨ï¼ˆç”¨äºå¿«é€Ÿåˆ‡æ¢ï¼‰
        let foldersByParentId = {};

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            // è·å–ç”¨æˆ·é…ç½®ï¼Œè·å– root_dir_id
            try {
                const configResponse = await fetch(`${API_BASE}/config/public`, {
                    credentials: 'include'
                });
                const configData = await configResponse.json();
                console.log('ç”¨æˆ·é…ç½®:', configData);
                if (configData.success && configData.pan123) {
                    userRootDirId = configData.pan123.root_dir_id || 0;
                    console.log('root_dir_id:', userRootDirId);
                    // ç›´æ¥ä½¿ç”¨ root_dir_id ä½œä¸ºå½“å‰ç›®å½•
                    currentParentId = userRootDirId;
                    folderPathStack = [{ id: userRootDirId, name: 'æ ¹ç›®å½•' }];
                }
            } catch (error) {
                console.error('è·å–ç”¨æˆ·é…ç½®å¤±è´¥:', error);
            }

            console.log('å½“å‰ç›®å½•ID:', currentParentId);
            console.log('è·¯å¾„æ ˆ:', folderPathStack);

            // ç›´æ¥åŠ è½½æŒ‡å®šç›®å½•ä¸‹çš„æ–‡ä»¶å¤¹
            await loadFolders(currentParentId);
            updatePathDisplay();

            // æ·»åŠ æœç´¢æ¡†å›è½¦äº‹ä»¶
            document.getElementById('folder-search').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchFolders();
                }
            });
        });

        // åŠ è½½æ–‡ä»¶å¤¹åˆ—è¡¨
        async function loadFolders(parentId, forceRefresh = false) {
            const folderList = document.getElementById('folder-list');

            // å¦‚æœå·²ç»ç¼“å­˜è¿‡è¯¥ç›®å½•çš„æ–‡ä»¶å¤¹åˆ—è¡¨ï¼Œç›´æ¥ä½¿ç”¨ç¼“å­˜
            if (!forceRefresh && foldersByParentId[parentId]) {
                const cachedFolders = foldersByParentId[parentId];
                renderFolders(cachedFolders);
                return;
            }

            folderList.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                // ä½¿ç”¨å…¬å¼€APIï¼Œå› ä¸ºè¿™æ˜¯ç‹¬ç«‹é¡µé¢ï¼Œé€šè¿‡session cookieè‡ªåŠ¨è®¤è¯
                // æœåŠ¡å™¨ç«¯ä¼šè‡ªåŠ¨ä½¿ç”¨åˆ†æ‰¹åŠ è½½ï¼ˆlast_file_idï¼‰ï¼Œè¿™é‡Œlimitå‚æ•°ä¼šè¢«å¿½ç•¥
                const response = await fetch(`${API_BASE}/folders/public?parent_id=${parentId}`, {
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.success) {
                    // ç¼“å­˜è¯¥ç›®å½•çš„æ–‡ä»¶å¤¹åˆ—è¡¨
                    foldersByParentId[parentId] = data.folders || [];

                    if (data.folders && data.folders.length > 0) {
                        renderFolders(data.folders);
                    } else {
                        folderList.innerHTML = '<div class="empty">æ­¤ç›®å½•ä¸ºç©º</div>';
                    }
                } else {
                    folderList.innerHTML = '<div class="loading">åŠ è½½å¤±è´¥</div>';
                }
            } catch (error) {
                console.error('åŠ è½½æ–‡ä»¶å¤¹åˆ—è¡¨å¤±è´¥:', error);
                folderList.innerHTML = '<div class="loading">åŠ è½½å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // æ¸²æŸ“æ–‡ä»¶å¤¹åˆ—è¡¨ï¼ˆä»ç¼“å­˜æˆ–æ–°æ•°æ®ï¼‰
        function renderFolders(folders) {
            const folderList = document.getElementById('folder-list');

            // æŒ‰ä¿®æ”¹æ—¶é—´æ’åºï¼Œæ–°çš„åœ¨ä¸Šé¢ï¼ˆupdate_at å­—æ®µï¼‰
            const sortedFolders = folders.sort((a, b) => {
                // ä½¿ç”¨ update_at å­—æ®µï¼ŒæŒ‰æ—¶é—´é™åºæ’åºï¼ˆä¿®æ”¹æ—¶é—´æ–°çš„åœ¨ä¸Šé¢ï¼‰
                if (a.update_at && b.update_at) {
                    return new Date(b.update_at) - new Date(a.update_at);
                }
                // æ²¡æœ‰ä¿®æ”¹æ—¶é—´ï¼ŒæŒ‰åˆ›å»ºæ—¶é—´æ’åº
                if (a.create_at && b.create_at) {
                    return new Date(b.create_at) - new Date(a.create_at);
                }
                // æ²¡æœ‰æ—¶é—´å­—æ®µï¼ŒæŒ‰æ–‡ä»¶åæ’åº
                return a.filename.localeCompare(b.filename);
            });

            folderList.innerHTML = sortedFolders.map(folder => `
                <div class="folder-item" data-id="${folder.file_id}" data-name="${escapeHtml(folder.filename)}"
                     onclick="selectFolder(this)" ondblclick="enterFolder(${folder.file_id}, '${escapeHtml(folder.filename)}')">
                    <span class="folder-item-icon">ğŸ“</span>
                    <div class="folder-item-info">
                        <div class="folder-item-name">${escapeHtml(folder.filename)}</div>
                        <div class="folder-item-id">ID: ${folder.file_id}</div>
                    </div>
                </div>
            `).join('');
        }

        // é€‰æ‹©æ–‡ä»¶å¤¹
        function selectFolder(element) {
            // ç§»é™¤å…¶ä»–é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.folder-item').forEach(item => {
                item.classList.remove('selected');
            });

            // æ·»åŠ é€‰ä¸­çŠ¶æ€
            element.classList.add('selected');
            selectedFolderId = parseInt(element.dataset.id);

            // æ›´æ–°è¾“å…¥æ¡†ï¼ˆè½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼‰
            document.getElementById('selected-folder-id').value = String(selectedFolderId);
        }

        // åŒå‡»è¿›å…¥æ–‡ä»¶å¤¹
        function enterFolder(folderId, folderName) {
            selectedFolderId = folderId;
            currentParentId = folderId;
            folderPathStack.push({ id: folderId, name: folderName });
            // ä½¿ç”¨ç¼“å­˜åŠ è½½ï¼Œä¸é‡æ–°è¯·æ±‚ï¼ˆé™¤éç¬¬ä¸€æ¬¡è®¿é—®è¯¥ç›®å½•ï¼‰
            loadFolders(folderId, false);
            updatePathDisplay();
        }

        // è¿”å›ä¸Šä¸€çº§
        function goBackFolder() {
            if (folderPathStack.length > 1) {
                folderPathStack.pop();
                const prev = folderPathStack[folderPathStack.length - 1];
                currentParentId = prev.id;
                // ä½¿ç”¨ç¼“å­˜åŠ è½½ï¼Œä¸é‡æ–°è¯·æ±‚
                loadFolders(prev.id, false);
                updatePathDisplay();
                selectedFolderId = null;
                document.getElementById('selected-folder-id').value = '';
            }
        }

        // æ›´æ–°è·¯å¾„æ˜¾ç¤º
        function updatePathDisplay() {
            const pathSpan = document.getElementById('current-path');
            if (pathSpan) {
                const path = folderPathStack.map(item => item.name).join(' / ');
                pathSpan.textContent = '/' + path;
            }
        }

        // æœç´¢æ–‡ä»¶å¤¹
        async function searchFolders() {
            const searchInput = document.getElementById('folder-search');
            const searchTerm = searchInput.value.trim().toLowerCase();

            if (!searchTerm) {
                alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                return;
            }

            const folderList = document.getElementById('folder-list');
            folderList.innerHTML = '<div class="loading">æœç´¢ä¸­...</div>';

            try {
                // å¦‚æœè¿˜æ²¡æœ‰ç¼“å­˜ï¼Œå…ˆåŠ è½½æ‰€æœ‰æ–‡ä»¶å¤¹
                if (!allFoldersCache) {
                    const searchStatus = document.getElementById('search-status');
                    searchStatus.textContent = 'æ­£åœ¨ä»æœåŠ¡å™¨åŠ è½½æ–‡ä»¶å¤¹åˆ—è¡¨...';
                    searchStatus.style.display = 'block';

                    const response = await fetch(`${API_BASE}/folders/public?parent_id=${userRootDirId}`, {
                        credentials: 'include'
                    });
                    const data = await response.json();

                    if (data.success && data.folders) {
                        allFoldersCache = data.folders;
                        searchStatus.textContent = `å·²åŠ è½½ ${data.folders.length} ä¸ªæ–‡ä»¶å¤¹`;
                        // 5ç§’åéšè—çŠ¶æ€
                        setTimeout(() => {
                            searchStatus.style.display = 'none';
                        }, 5000);
                    } else {
                        folderList.innerHTML = '<div class="empty">åŠ è½½å¤±è´¥</div>';
                        return;
                    }
                }

                // æœ¬åœ°æœç´¢
                const filteredFolders = allFoldersCache.filter(folder => {
                    const filename = folder.filename.toLowerCase();
                    return filename.includes(searchTerm);
                });

                // æŒ‰ä¿®æ”¹æ—¶é—´æ’åº
                const sortedFolders = filteredFolders.sort((a, b) => {
                    if (a.update_at && b.update_at) {
                        return new Date(b.update_at) - new Date(a.update_at);
                    }
                    if (a.create_at && b.create_at) {
                        return new Date(b.create_at) - new Date(a.create_at);
                    }
                    return a.filename.localeCompare(b.filename);
                });

                if (sortedFolders.length > 0) {
                    isSearchMode = true;
                    folderList.innerHTML = sortedFolders.map(folder => `
                        <div class="folder-item" data-id="${folder.file_id}" data-name="${escapeHtml(folder.filename)}"
                             onclick="selectFolder(this)" ondblclick="enterFolder(${folder.file_id}, '${escapeHtml(folder.filename)}')">
                            <span class="folder-item-icon">ğŸ“</span>
                            <div class="folder-item-info">
                                <div class="folder-item-name">${escapeHtml(folder.filename)}</div>
                                <div class="folder-item-id">ID: ${folder.file_id}</div>
                            </div>
                        </div>
                    `).join('');

                    const searchStatus = document.getElementById('search-status');
                    searchStatus.textContent = `æ‰¾åˆ° ${sortedFolders.length} ä¸ªåŒ¹é…çš„æ–‡ä»¶å¤¹`;
                } else {
                    folderList.innerHTML = '<div class="empty">æœªæ‰¾åˆ°åŒ¹é…çš„æ–‡ä»¶å¤¹</div>';
                    const searchStatus = document.getElementById('search-status');
                    searchStatus.textContent = 'æœªæ‰¾åˆ°åŒ¹é…çš„æ–‡ä»¶å¤¹';
                }
            } catch (error) {
                console.error('æœç´¢å¤±è´¥:', error);
                folderList.innerHTML = '<div class="loading">æœç´¢å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // æ¸…é™¤æœç´¢
        function clearSearch() {
            document.getElementById('folder-search').value = '';
            isSearchMode = false;
            // ä½¿ç”¨ç¼“å­˜åŠ è½½ï¼Œä¸é‡æ–°è¯·æ±‚
            loadFolders(currentParentId, false);
            const searchStatus = document.getElementById('search-status');
            if (searchStatus) {
                searchStatus.textContent = '';
            }
        }

        // å¤åˆ¶æ–‡ä»¶å¤¹ID
        async function copyFolderId() {
            const input = document.getElementById('selected-folder-id');
            const folderId = input.value;
            if (!folderId) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡ä»¶å¤¹');
                return;
            }

            const folderIdStr = String(folderId);

            // ä¼˜å…ˆä½¿ç”¨ navigator.clipboard
            if (navigator.clipboard && navigator.clipboard.writeText) {
                try {
                    await navigator.clipboard.writeText(folderIdStr);
                    alert(`æ–‡ä»¶å¤¹IDå·²å¤åˆ¶: ${folderIdStr}`);
                    // å¯é€‰ï¼šå…³é—­çª—å£
                    // window.close();
                    return;
                } catch (err) {
                    console.error('navigator.clipboard å¤åˆ¶å¤±è´¥ï¼Œå°è¯•é™çº§æ–¹æ¡ˆ:', err);
                }
            }

            // é™çº§æ–¹æ¡ˆï¼šæ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬
            try {
                input.select();
                input.setSelectionRange(0, input.value.length); // å…¼å®¹ç§»åŠ¨ç«¯
                const successful = document.execCommand('copy');

                // å–æ¶ˆé€‰ä¸­æ–‡æœ¬
                input.setSelectionRange(0, 0);
                input.blur();

                if (successful) {
                    alert(`æ–‡ä»¶å¤¹IDå·²å¤åˆ¶: ${folderIdStr}`);
                } else {
                    throw new Error('execCommand copy failed');
                }
            } catch (err) {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            }
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
